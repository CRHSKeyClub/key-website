<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Club Attendance Import Tool</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .instructions {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .instructions h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .step {
            margin: 30px 0;
            padding: 25px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px dashed #e5e7eb;
        }

        .step h3 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .file-input {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .file-input:hover {
            border-color: #764ba2;
            background: #f9f4ff;
        }

        .file-input p {
            color: #667eea;
            font-size: 1.1em;
            margin: 5px 0;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .status.warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f9fafb;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .month-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .month-selector label {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .month-selector label:hover {
            border-color: #667eea;
        }

        .month-selector input[type="radio"]:checked + span {
            color: #667eea;
            font-weight: 600;
        }

        .month-selector input[type="radio"] {
            margin: 0;
        }

        #previewContainer {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card .label {
            color: #6b7280;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã Key Club Attendance Import Tool</h1>

        <div class="instructions">
            <h3>üìã Instructions</h3>
            <ol>
                <li>Your CSV should have columns for <strong>Student ID/S-Number</strong> and <strong>Meeting Date</strong></li>
                <li>Select the month (September, October, or November) for this import</li>
                <li>Upload your CSV file (or Excel file)</li>
                <li>Review the preview to ensure data is parsed correctly</li>
                <li>Click "Generate Import Script" to get JavaScript code you can run in browser console</li>
                <li>Or use the generated SQL to import directly into Supabase</li>
            </ol>
            <p><strong>Note:</strong> Meetings will be automatically created if they don't exist for the specified dates.</p>
        </div>

        <div class="step">
            <h3>Step 1: Select Month</h3>
            <div class="month-selector">
                <label>
                    <input type="radio" name="month" value="september" checked>
                    <span>September 2025</span>
                </label>
                <label>
                    <input type="radio" name="month" value="october">
                    <span>October 2025</span>
                </label>
                <label>
                    <input type="radio" name="month" value="november">
                    <span>November 2025</span>
                </label>
            </div>
        </div>

        <div class="step">
            <h3>Step 2: Upload CSV File</h3>
            <div class="file-input" onclick="document.getElementById('csvFile').click()">
                <input
                    type="file"
                    id="csvFile"
                    accept=".csv,.xlsx,.xls"
                    style="display: none"
                    onchange="handleFileUpload(event)"
                />
                <p>üìÅ Click to select your CSV (or Excel) file</p>
                <p style="color: #6b7280; font-size: 14px">
                    The file should have Student ID/S-Number and Meeting Date columns
                </p>
            </div>
            <div id="fileStatus"></div>
        </div>

        <div class="step" id="previewStep" style="display: none">
            <h3>Step 3: Preview Data</h3>
            <div class="stats" id="statsContainer"></div>
            <div id="previewContainer"></div>
            <button onclick="generateImportScript()">Generate Import Script</button>
        </div>

        <div class="step" id="scriptStep" style="display: none">
            <h3>Step 4: Import Script</h3>
            <div id="scriptContainer"></div>
        </div>
    </div>

    <script>
        let csvData = [];
        let processedData = [];
        let selectedMonth = 'september';

        const monthDates = {
            september: { year: 2025, month: 9, name: 'September 2025' },
            october: { year: 2025, month: 10, name: 'October 2025' },
            november: { year: 2025, month: 11, name: 'November 2025' }
        };

        document.querySelectorAll('input[name="month"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                selectedMonth = e.target.value;
            });
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileStatus = document.getElementById('fileStatus');
            fileStatus.innerHTML = '<div class="status info">üìÅ Processing file: ' + file.name + '</div>';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    csvData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (csvData.length === 0) {
                        throw new Error('No data found in the file');
                    }

                    processData();
                    showPreview();
                    fileStatus.innerHTML = '<div class="status success">‚úÖ File loaded successfully! Found ' + (csvData.length - 1) + ' rows of data.</div>';
                } catch (error) {
                    fileStatus.innerHTML = '<div class="status error">‚ùå Error reading file: ' + error.message + '</div>';
                }
            };
            reader.readAsBinaryString(file);
        }

        function findColumnIndex(headers, candidates) {
            const normalizedHeaders = headers.map(h => (h || '').toString().trim().toLowerCase());
            for (const cand of candidates) {
                const idx = normalizedHeaders.findIndex(h => h.includes(cand));
                if (idx !== -1) return idx;
            }
            return -1;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Handle timestamp format: "11/9/2025 15:11:16" or "11/11/2025 7:14:44"
            // Extract just the date part
            const datePart = dateStr.toString().split(' ')[0];
            
            // Try MM/DD/YYYY format (from timestamp)
            const parts = datePart.split('/');
            if (parts.length === 3) {
                const month = parseInt(parts[0]);
                const day = parseInt(parts[1]);
                const year = parseInt(parts[2]);
                
                if (!isNaN(month) && !isNaN(day) && !isNaN(year)) {
                    const date = new Date(year, month - 1, day);
                    if (!isNaN(date.getTime())) return date;
                }
            }
            
            // Try standard Date parsing
            let date = new Date(dateStr);
            if (!isNaN(date.getTime())) {
                return date;
            }
            
            // Try YYYY-MM-DD
            const parts2 = dateStr.toString().split('-');
            if (parts2.length === 3) {
                date = new Date(parts2[0], parts2[1] - 1, parts2[2]);
                if (!isNaN(date.getTime())) return date;
            }
            
            return null;
        }

        function processData() {
            const headers = csvData[0];
            const rows = csvData.slice(1);

            // Find columns - support both "S Number (No S)" and "S Number (no S)"
            const sNumberIdx = findColumnIndex(headers, [
                's number (no s)', 's number (no s)', 'student id', 'studentid', 
                's-number', 's number', 's_number', 's#', 'id', 'student', 
                'member id', 'memberid'
            ]);
            
            // Date is in Timestamp column for these CSVs
            const timestampIdx = findColumnIndex(headers, [
                'timestamp', 'date', 'meeting date', 'attendance date', 
                'meeting_date', 'attendance_date'
            ]);
            
            // Meeting Time column for session_type
            const meetingTimeIdx = findColumnIndex(headers, [
                'meeting time', 'time', 'session', 'session type'
            ]);

            if (sNumberIdx === -1) {
                throw new Error('Could not find Student ID/S-Number column. Please check your CSV headers.');
            }

            if (timestampIdx === -1) {
                throw new Error('Could not find Timestamp/Date column. Please check your CSV headers.');
            }

            const monthInfo = monthDates[selectedMonth];
            const processedRows = [];

            rows.forEach((row, index) => {
                const rawS = row[sNumberIdx];
                const rawTimestamp = row[timestampIdx];
                const rawMeetingTime = meetingTimeIdx !== -1 ? row[meetingTimeIdx] : null;

                if (!rawS) return; // Skip rows without S-number

                // Process S-number: normalize to lowercase, ensure 's' prefix
                let sNumber = rawS.toString().trim().toLowerCase();
                // Remove any existing 's' prefix, then add it back
                sNumber = sNumber.replace(/^s/, '');
                // Extract only digits
                const digits = sNumber.replace(/[^0-9]/g, '');
                if (!digits) return; // Skip if no digits found
                sNumber = 's' + digits;

                // Parse date from timestamp
                let meetingDate = parseDate(rawTimestamp);
                
                if (!meetingDate || isNaN(meetingDate.getTime())) {
                    console.warn(`Row ${index + 2}: Could not parse date from timestamp "${rawTimestamp}"`);
                    return;
                }

                // Determine session type from Meeting Time
                let sessionType = 'both'; // default
                if (rawMeetingTime) {
                    const timeStr = rawMeetingTime.toString().trim().toLowerCase();
                    if (timeStr.includes('morning')) {
                        sessionType = 'morning';
                    } else if (timeStr.includes('afternoon')) {
                        sessionType = 'afternoon';
                    }
                }

                processedRows.push({
                    sNumber: sNumber,
                    meetingDate: meetingDate.toISOString().split('T')[0], // YYYY-MM-DD format
                    sessionType: sessionType,
                    rawTimestamp: rawTimestamp,
                    rawMeetingTime: rawMeetingTime,
                    rowNumber: index + 2
                });
            });

            // Group by date to create meetings
            const meetingsByDate = {};
            processedRows.forEach(row => {
                if (!meetingsByDate[row.meetingDate]) {
                    meetingsByDate[row.meetingDate] = [];
                }
                meetingsByDate[row.meetingDate].push(row.sNumber);
            });

            processedData = {
                rows: processedRows,
                meetings: Object.keys(meetingsByDate).map(date => ({
                    date: date,
                    students: meetingsByDate[date]
                }))
            };
        }

        function showPreview() {
            const previewStep = document.getElementById('previewStep');
            const previewContainer = document.getElementById('previewContainer');
            const statsContainer = document.getElementById('statsContainer');

            previewStep.style.display = 'block';

            // Show stats
            const uniqueStudents = new Set(processedData.rows.map(r => r.sNumber));
            const uniqueDates = new Set(processedData.rows.map(r => r.meetingDate));
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="number">${processedData.rows.length}</div>
                    <div class="label">Total Attendance Records</div>
                </div>
                <div class="stat-card">
                    <div class="number">${uniqueStudents.size}</div>
                    <div class="label">Unique Students</div>
                </div>
                <div class="stat-card">
                    <div class="number">${uniqueDates.size}</div>
                    <div class="label">Meeting Dates</div>
                </div>
            `;

            // Show preview table
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Row</th>
                        <th>S-Number</th>
                        <th>Meeting Date</th>
                        <th>Session Type</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    ${processedData.rows.slice(0, 50).map(row => `
                        <tr>
                            <td>${row.rowNumber}</td>
                            <td>${row.sNumber}</td>
                            <td>${row.meetingDate}</td>
                            <td>${row.sessionType || 'both'}</td>
                            <td>${row.rawTimestamp || ''}</td>
                        </tr>
                    `).join('')}
                    ${processedData.rows.length > 50 ? `<tr><td colspan="5" style="text-align: center; color: #6b7280;">... and ${processedData.rows.length - 50} more rows</td></tr>` : ''}
                </tbody>
            `;
            previewContainer.innerHTML = '';
            previewContainer.appendChild(table);
        }

        function generateImportScript() {
            const scriptStep = document.getElementById('scriptStep');
            const scriptContainer = document.getElementById('scriptContainer');

            scriptStep.style.display = 'block';

            // Generate import data as JSON and provide code to use with SupabaseService
            const importData = processedData.rows.map(row => ({
                student_s_number: row.sNumber,
                meeting_date: row.meetingDate,
                attendance_code: 'IMPORTED',
                session_type: row.sessionType || 'both'
            }));

            // Generate JavaScript code that uses SupabaseService.bulkImportAttendance
            const jsCode = `
// Attendance Import Script for ${monthDates[selectedMonth].name}
// Copy and paste this into your browser console on the admin page
// Make sure SupabaseService is available (you're on an admin page)

const importData = ${JSON.stringify(importData, null, 2)};

// Use the bulk import method
SupabaseService.bulkImportAttendance(importData)
    .then(results => {
        console.log('‚úÖ Import Complete!');
        console.log(\`Success: \${results.success}\`);
        console.log(\`Skipped: \${results.skipped}\`);
        console.log(\`Errors: \${results.errors}\`);
        if (results.errorDetails.length > 0) {
            console.warn('Error details:', results.errorDetails);
        }
        alert(\`Import complete! Success: \${results.success}, Skipped: \${results.skipped}, Errors: \${results.errors}\`);
    })
    .catch(error => {
        console.error('‚ùå Import failed:', error);
        alert('Import failed: ' + error.message);
    });
            `.trim();

            // Also provide direct API code as alternative
            const directApiCode = `
// Alternative: Direct Supabase API code (if SupabaseService not available)
// You'll need to have supabase client available

const importData = ${JSON.stringify(importData, null, 2)};

(async function() {
    console.log('Starting attendance import...');
    
    // Group by date to create/get meetings
    const dates = [...new Set(importData.map(r => r.meeting_date))];
    const meetingMap = {};
    
    // Create or get meetings
    for (const date of dates) {
        let { data: existing } = await supabase
            .from('meetings')
            .select('id')
            .eq('meeting_date', date)
            .limit(1);
        
        let meetingId;
        if (existing && existing.length > 0) {
            meetingId = existing[0].id;
        } else {
            const { data: newMeeting, error } = await supabase
                .from('meetings')
                .insert([{
                    meeting_date: date,
                    meeting_type: 'General Meeting',
                    attendance_code: 'ATTEND',
                    is_open: false,
                    created_by: 'admin',
                    created_at: new Date().toISOString()
                }])
                .select()
                .single();
            if (error) {
                console.error(\`Error creating meeting for \${date}:\`, error);
                continue;
            }
            meetingId = newMeeting.id;
        }
        meetingMap[date] = meetingId;
    }
    
    // Insert attendance records
    let success = 0, skipped = 0, errors = 0;
    for (const record of importData) {
        const meetingId = meetingMap[record.meeting_date];
        if (!meetingId) {
            errors++;
            continue;
        }
        
        // Check for existing
        const { data: existing } = await supabase
            .from('meeting_attendance')
            .select('id')
            .eq('meeting_id', meetingId)
            .eq('student_s_number', record.student_s_number.toLowerCase())
            .limit(1);
        
        if (existing && existing.length > 0) {
            skipped++;
            continue;
        }
        
        const { error } = await supabase
            .from('meeting_attendance')
            .insert([{
                meeting_id: meetingId,
                student_s_number: record.student_s_number.toLowerCase(),
                attendance_code: record.attendance_code,
                session_type: record.session_type,
                submitted_at: new Date().toISOString()
            }]);
        
        if (error) {
            errors++;
            console.error('Error:', error);
        } else {
            success++;
        }
    }
    
    console.log(\`Done! Success: \${success}, Skipped: \${skipped}, Errors: \${errors}\`);
})();
            `.trim();

            scriptContainer.innerHTML = `
                <div class="status info">
                    <strong>Method 1: Using SupabaseService (Recommended)</strong>
                    <p style="margin-top: 10px;">Open any admin page, press F12, go to Console tab, paste this code, and press Enter.</p>
                </div>
                <textarea 
                    readonly 
                    id="script1"
                    style="width: 100%; height: 300px; font-family: monospace; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 12px; margin-bottom: 20px;"
                    onclick="this.select()"
                >${jsCode}</textarea>
                
                <div class="status warning">
                    <strong>Method 2: Direct Supabase API (Alternative)</strong>
                    <p style="margin-top: 10px;">Use this if Method 1 doesn't work. Requires supabase client in console.</p>
                </div>
                <textarea 
                    readonly 
                    id="script2"
                    style="width: 100%; height: 400px; font-family: monospace; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 12px; margin-bottom: 20px;"
                    onclick="this.select()"
                >${directApiCode}</textarea>
                
                <button onclick="document.getElementById('script1').select(); document.execCommand('copy'); alert('Method 1 code copied!')">Copy Method 1</button>
                <button onclick="document.getElementById('script2').select(); document.execCommand('copy'); alert('Method 2 code copied!')">Copy Method 2</button>
            `;

            scriptStep.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
